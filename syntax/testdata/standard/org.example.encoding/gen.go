// This file was automatically generated by snai.pe/go-varlink/codegen
// DO NOT EDIT

// Example Varlink service
package encoding

import (
	"context"
	"encoding/json"
	"fmt"

	"snai.pe/go-varlink"

	"snai.pe/go-varlink/syntax"
)

var _ = fmt.Errorf
var _ = json.RawMessage(nil)
var _ = context.Background

// InterfaceName is the fully-qualified name of this varlink interface.
const InterfaceName = `org.example.encoding`

type State struct {
	Start    *bool `json:"start,omitempty"`
	Progress *int  `json:"progress,omitempty"`
	End      *bool `json:"end,omitempty"`
}

type Shipment struct {
	Name        string `json:"name"`
	Description string `json:"description"`
	Size        int    `json:"size"`
	Weight      *int   `json:"weight,omitempty"`
}

type Order struct {
	Shipments []Shipment `json:"shipments"`
	OrderNum  int        `json:"order_num"`
	Customer  string     `json:"customer"`
}

// Input parameters for Ping method.
//
// You shouldn't have to use this type directly; it is only useful if you
// need to manually send method calls. Instead, use the methods of the
// Client type.
type PingInput struct {
	Ping string `json:"ping"`
}

// Pack fills in the fields of PingInput from a
// parameter list.
func (input_ *PingInput) Pack(ping string) {
	input_.Ping = ping
}

// Unpack unpacks the fields of PingInput to a
// parameter list.
func (input_ *PingInput) Unpack() (ping string) {
	ping = input_.Ping
	return
}

// Output parameters for Ping method.
//
// You shouldn't have to use this type directly; it is only useful if you
// need to manually send method calls. Instead, use the methods of the
// Client type.
type PingOutput struct {
	Pong string `json:"pong"`
}

// Pack fills in the fields of PingOutput from a
// parameter list.
func (output_ *PingOutput) Pack(pong string) {
	output_.Pong = pong
}

// Unpack unpacks the fields of PingInput to a
// parameter list.
func (output_ *PingOutput) Unpack() (pong string) {
	pong = output_.Pong
	return
}

// Input parameters for GetOrder method.
//
// You shouldn't have to use this type directly; it is only useful if you
// need to manually send method calls. Instead, use the methods of the
// Client type.
type GetOrderInput struct {
	Num int `json:"num"`
}

// Pack fills in the fields of GetOrderInput from a
// parameter list.
func (input_ *GetOrderInput) Pack(num int) {
	input_.Num = num
}

// Unpack unpacks the fields of GetOrderInput to a
// parameter list.
func (input_ *GetOrderInput) Unpack() (num int) {
	num = input_.Num
	return
}

// Output parameters for GetOrder method.
//
// You shouldn't have to use this type directly; it is only useful if you
// need to manually send method calls. Instead, use the methods of the
// Client type.
type GetOrderOutput struct {
	Order Order `json:"order"`
}

func (output *GetOrderOutput) Validate(param string) varlink.Error {
	if v, ok := any(output.Order).(interface{ Validate() varlink.Error }); ok {
		if err := v.Validate(); err != nil {
			return err
		}
	}
	return nil
}

// Pack fills in the fields of GetOrderOutput from a
// parameter list.
func (output_ *GetOrderOutput) Pack(order Order) {
	output_.Order = order
}

// Unpack unpacks the fields of GetOrderInput to a
// parameter list.
func (output_ *GetOrderOutput) Unpack() (order Order) {
	order = output_.Order
	return
}

// Client represents a varlink client that implements the org.example.encoding
// interface.
type Client struct {
	varlink.Client
}

// ErrorFromCode returns a new varlink error constructed from the specified
// code and parameters.
func ErrorFromCode(code string, params json.RawMessage) varlink.Error {
	switch code {
	default:
		var kvargs []any
		var pmap map[string]any
		if err2_ := json.Unmarshal([]byte(params), &pmap); err2_ != nil {
			panic(`programming error: ` + code + ` params is invalid json: ` + err2_.Error())
		}
		for k, v := range pmap {
			kvargs = append(kvargs, k, v)
		}
		return varlink.NewError(code, kvargs...)
	}
}

// Returns the same string
func (client_ *Client) Ping(ctx context.Context, ping string) (pong string, err_ error) {
	var (
		input_  PingInput
		output_ PingOutput
	)

	input_.Pack(ping)

	rs, err := client_.Call(ctx, `org.example.encoding.Ping`, &input_)
	if err != nil {
		err_ = err
		return
	}

	for rs.Next() {
		r := rs.Reply()
		if r.Error != "" {
			err_ = ErrorFromCode(r.Error, r.Parameters)
			return
		}
		if r.Continues {
			err_ = fmt.Errorf("more than one reply on single-reply call")
			return
		}

		if err := rs.Unmarshal(&output_); err != nil {
			err_ = err
			return
		}
	}
	if err := rs.Error(); err != nil {
		err_ = err
		return
	}

	pong = output_.Unpack()
	return
}

// Returns a fake order given an order number
func (client_ *Client) GetOrder(ctx context.Context, num int) (order Order, err_ error) {
	var (
		input_  GetOrderInput
		output_ GetOrderOutput
	)

	input_.Pack(num)

	rs, err := client_.Call(ctx, `org.example.encoding.GetOrder`, &input_)
	if err != nil {
		err_ = err
		return
	}

	for rs.Next() {
		r := rs.Reply()
		if r.Error != "" {
			err_ = ErrorFromCode(r.Error, r.Parameters)
			return
		}
		if r.Continues {
			err_ = fmt.Errorf("more than one reply on single-reply call")
			return
		}

		if err := rs.Unmarshal(&output_); err != nil {
			err_ = err
			return
		}
	}
	if err := rs.Error(); err != nil {
		err_ = err
		return
	}

	order = output_.Unpack()
	return
}

// Service is the interface that servers that implement the org.example.encoding
// varlink interface must adhere to.
type Service interface {

	// Returns the same string
	Ping(ctx context.Context, ping string) (pong string, err_ varlink.Error)

	// Returns a fake order given an order number
	GetOrder(ctx context.Context, num int) (order Order, err_ varlink.Error)
}

// NewHandler creates a new method handler for the specified service implementation.
func NewHandler(s Service) varlink.MethodHandler {
	var mux varlink.ServeMux
	RegisterHandlers(&mux, s)
	return &mux
}

// RegisterHandlers registers all of the method handlers for the specified
// service implementation into the passed ServeMux.
func RegisterHandlers(mux *varlink.ServeMux, s Service) {
	mux.HandleFunc("org.example.encoding.Ping", func(w varlink.ReplyWriter, call *varlink.Call) {
		var (
			input  PingInput
			output PingOutput
		)

		if err := call.Unmarshal(&input); err != nil {
			w.WriteError(err)
			return
		}

		validate := func() varlink.Error {

			return nil
		}
		if err := validate(); err != nil {
			w.WriteError(err)
			return
		}

		var err varlink.Error
		output.Pong, err = s.Ping(w.Context(), input.Ping)
		if err != nil {
			w.WriteError(err)
			return
		}

		w.WriteReply(&output)
	})
	mux.HandleFunc("org.example.encoding.GetOrder", func(w varlink.ReplyWriter, call *varlink.Call) {
		var (
			input  GetOrderInput
			output GetOrderOutput
		)

		if err := call.Unmarshal(&input); err != nil {
			w.WriteError(err)
			return
		}

		validate := func() varlink.Error {

			return nil
		}
		if err := validate(); err != nil {
			w.WriteError(err)
			return
		}

		var err varlink.Error
		output.Order, err = s.GetOrder(w.Context(), input.Num)
		if err != nil {
			w.WriteError(err)
			return
		}

		w.WriteReply(&output)
	})
}

// Definition contains the definition of the varlink interface which was parsed from its description.
var Definition = syntax.InterfaceDef{Node: syntax.Node{Position: syntax.Cursor{Line: 2, Column: 1}, Comments: []syntax.Token{syntax.Token{Type: "<comment>", Raw: "# Example Varlink service\n", Value: "Example Varlink service", Start: syntax.Cursor{Line: 1, Column: 1}, End: syntax.Cursor{Line: 1, Column: 26}}}}, Name: "org.example.encoding", Types: []syntax.TypeDef{syntax.TypeDef{Node: syntax.Node{Position: syntax.Cursor{Line: 4, Column: 1}, Comments: []syntax.Token(nil)}, Name: "State", Type: syntax.Struct{Node: syntax.Node{Position: syntax.Cursor{Line: 4, Column: 12}, Comments: []syntax.Token(nil)}, Fields: []syntax.StructField{syntax.StructField{Node: syntax.Node{Position: syntax.Cursor{Line: 5, Column: 3}, Comments: []syntax.Token(nil)}, Name: "start", Type: syntax.NullableType{Node: syntax.Node{Position: syntax.Cursor{Line: 5, Column: 10}, Comments: []syntax.Token(nil)}, Type: syntax.BuiltinType{Node: syntax.Node{Position: syntax.Cursor{Line: 5, Column: 11}, Comments: []syntax.Token(nil)}, Name: "bool"}}}, syntax.StructField{Node: syntax.Node{Position: syntax.Cursor{Line: 6, Column: 3}, Comments: []syntax.Token(nil)}, Name: "progress", Type: syntax.NullableType{Node: syntax.Node{Position: syntax.Cursor{Line: 6, Column: 13}, Comments: []syntax.Token(nil)}, Type: syntax.BuiltinType{Node: syntax.Node{Position: syntax.Cursor{Line: 6, Column: 14}, Comments: []syntax.Token(nil)}, Name: "int"}}}, syntax.StructField{Node: syntax.Node{Position: syntax.Cursor{Line: 7, Column: 3}, Comments: []syntax.Token(nil)}, Name: "end", Type: syntax.NullableType{Node: syntax.Node{Position: syntax.Cursor{Line: 7, Column: 8}, Comments: []syntax.Token(nil)}, Type: syntax.BuiltinType{Node: syntax.Node{Position: syntax.Cursor{Line: 7, Column: 9}, Comments: []syntax.Token(nil)}, Name: "bool"}}}}}}, syntax.TypeDef{Node: syntax.Node{Position: syntax.Cursor{Line: 10, Column: 1}, Comments: []syntax.Token(nil)}, Name: "Shipment", Type: syntax.Struct{Node: syntax.Node{Position: syntax.Cursor{Line: 10, Column: 15}, Comments: []syntax.Token(nil)}, Fields: []syntax.StructField{syntax.StructField{Node: syntax.Node{Position: syntax.Cursor{Line: 11, Column: 3}, Comments: []syntax.Token(nil)}, Name: "name", Type: syntax.BuiltinType{Node: syntax.Node{Position: syntax.Cursor{Line: 11, Column: 9}, Comments: []syntax.Token(nil)}, Name: "string"}}, syntax.StructField{Node: syntax.Node{Position: syntax.Cursor{Line: 12, Column: 3}, Comments: []syntax.Token(nil)}, Name: "description", Type: syntax.BuiltinType{Node: syntax.Node{Position: syntax.Cursor{Line: 12, Column: 16}, Comments: []syntax.Token(nil)}, Name: "string"}}, syntax.StructField{Node: syntax.Node{Position: syntax.Cursor{Line: 13, Column: 3}, Comments: []syntax.Token(nil)}, Name: "size", Type: syntax.BuiltinType{Node: syntax.Node{Position: syntax.Cursor{Line: 13, Column: 9}, Comments: []syntax.Token(nil)}, Name: "int"}}, syntax.StructField{Node: syntax.Node{Position: syntax.Cursor{Line: 14, Column: 3}, Comments: []syntax.Token(nil)}, Name: "weight", Type: syntax.NullableType{Node: syntax.Node{Position: syntax.Cursor{Line: 14, Column: 11}, Comments: []syntax.Token(nil)}, Type: syntax.BuiltinType{Node: syntax.Node{Position: syntax.Cursor{Line: 14, Column: 12}, Comments: []syntax.Token(nil)}, Name: "int"}}}}}}, syntax.TypeDef{Node: syntax.Node{Position: syntax.Cursor{Line: 17, Column: 1}, Comments: []syntax.Token(nil)}, Name: "Order", Type: syntax.Struct{Node: syntax.Node{Position: syntax.Cursor{Line: 17, Column: 12}, Comments: []syntax.Token(nil)}, Fields: []syntax.StructField{syntax.StructField{Node: syntax.Node{Position: syntax.Cursor{Line: 18, Column: 3}, Comments: []syntax.Token(nil)}, Name: "shipments", Type: syntax.ArrayType{Node: syntax.Node{Position: syntax.Cursor{Line: 18, Column: 14}, Comments: []syntax.Token(nil)}, ElemType: syntax.NamedType{Node: syntax.Node{Position: syntax.Cursor{Line: 18, Column: 16}, Comments: []syntax.Token(nil)}, Name: "Shipment"}}}, syntax.StructField{Node: syntax.Node{Position: syntax.Cursor{Line: 19, Column: 3}, Comments: []syntax.Token(nil)}, Name: "order_num", Type: syntax.BuiltinType{Node: syntax.Node{Position: syntax.Cursor{Line: 19, Column: 14}, Comments: []syntax.Token(nil)}, Name: "int"}}, syntax.StructField{Node: syntax.Node{Position: syntax.Cursor{Line: 20, Column: 3}, Comments: []syntax.Token(nil)}, Name: "customer", Type: syntax.BuiltinType{Node: syntax.Node{Position: syntax.Cursor{Line: 20, Column: 13}, Comments: []syntax.Token(nil)}, Name: "string"}}}}}}, Methods: []syntax.MethodDef{syntax.MethodDef{Node: syntax.Node{Position: syntax.Cursor{Line: 24, Column: 1}, Comments: []syntax.Token{syntax.Token{Type: "<comment>", Raw: "# Returns the same string\n", Value: "Returns the same string", Start: syntax.Cursor{Line: 23, Column: 1}, End: syntax.Cursor{Line: 23, Column: 26}}}}, Name: "Ping", Input: syntax.Struct{Node: syntax.Node{Position: syntax.Cursor{Line: 24, Column: 12}, Comments: []syntax.Token(nil)}, Fields: []syntax.StructField{syntax.StructField{Node: syntax.Node{Position: syntax.Cursor{Line: 24, Column: 13}, Comments: []syntax.Token(nil)}, Name: "ping", Type: syntax.BuiltinType{Node: syntax.Node{Position: syntax.Cursor{Line: 24, Column: 19}, Comments: []syntax.Token(nil)}, Name: "string"}}}}, Output: syntax.Struct{Node: syntax.Node{Position: syntax.Cursor{Line: 24, Column: 30}, Comments: []syntax.Token(nil)}, Fields: []syntax.StructField{syntax.StructField{Node: syntax.Node{Position: syntax.Cursor{Line: 24, Column: 31}, Comments: []syntax.Token(nil)}, Name: "pong", Type: syntax.BuiltinType{Node: syntax.Node{Position: syntax.Cursor{Line: 24, Column: 37}, Comments: []syntax.Token(nil)}, Name: "string"}}}}}, syntax.MethodDef{Node: syntax.Node{Position: syntax.Cursor{Line: 27, Column: 1}, Comments: []syntax.Token{syntax.Token{Type: "<comment>", Raw: "# Returns a fake order given an order number\n", Value: "Returns a fake order given an order number", Start: syntax.Cursor{Line: 26, Column: 1}, End: syntax.Cursor{Line: 26, Column: 45}}}}, Name: "GetOrder", Input: syntax.Struct{Node: syntax.Node{Position: syntax.Cursor{Line: 27, Column: 16}, Comments: []syntax.Token(nil)}, Fields: []syntax.StructField{syntax.StructField{Node: syntax.Node{Position: syntax.Cursor{Line: 27, Column: 17}, Comments: []syntax.Token(nil)}, Name: "num", Type: syntax.BuiltinType{Node: syntax.Node{Position: syntax.Cursor{Line: 27, Column: 22}, Comments: []syntax.Token(nil)}, Name: "int"}}}}, Output: syntax.Struct{Node: syntax.Node{Position: syntax.Cursor{Line: 27, Column: 30}, Comments: []syntax.Token(nil)}, Fields: []syntax.StructField{syntax.StructField{Node: syntax.Node{Position: syntax.Cursor{Line: 27, Column: 31}, Comments: []syntax.Token(nil)}, Name: "order", Type: syntax.NamedType{Node: syntax.Node{Position: syntax.Cursor{Line: 27, Column: 38}, Comments: []syntax.Token(nil)}, Name: "Order"}}}}}}, Errors: []syntax.ErrorDef(nil)}

// Description contains the description of the varlink interface, expressed in the IDL.
var Description = `# Example Varlink service
interface org.example.encoding

type State (
  start: ?bool,
  progress: ?int,
  end: ?bool
)

type Shipment (
  name: string,
  description: string,
  size: int,
  weight: ?int
)

type Order (
  shipments: []Shipment,
  order_num: int,
  customer: string
)

# Returns the same string
method Ping(ping: string) -> (pong: string)

# Returns a fake order given an order number
method GetOrder(num: int) -> (order: Order)
`
